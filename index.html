<!DOCTYPE html>

<!-- saved from url=(0052)https://cestlaviesisyphus.github.io/Bedroom-Planner/ -->
<html lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>Bedroom Layout Planner – v12.2</title>
<style>
    /* ——— Layout & basic UI ——— */
    *{box-sizing:border-box}
    body{font-family:system-ui,sans-serif;display:flex;gap:1.5rem;padding:1rem;background:#f8fafc}
    canvas{border-radius:.5rem;box-shadow:0 2px 8px rgba(0,0,0,.1);touch-action:none;user-select:none}
    #panel{width:260px;display:flex;flex-direction:column;gap:1rem}
    h2{font-size:1.1rem;margin:0;font-weight:600;color:#334155}
    ul{list-style:none;margin:0;padding:0;max-height:260px;overflow:auto;border:1px solid #e2e8f0;border-radius:.5rem}
    li{padding:.35rem .5rem;cursor:pointer;border-bottom:1px solid #e2e8f0;display:flex;flex-direction:column;gap:.1rem}
    li:last-child{border-bottom:none}
    li.active{background:#e0f2fe}
    .row{display:flex;align-items:center;gap:.5rem}
    .swatch{width:16px;height:16px;border-radius:3px;border:1px solid #cbd5e1}
    .dim{font-size:.7rem;color:#64748b;margin-left:1.5rem}
    label{display:flex;flex-direction:column;font-size:.8rem;color:#475569;gap:.25rem}
    input,button{font:inherit;padding:.25rem .5rem;border:1px solid #cbd5e1;border-radius:.35rem}
    input[type="color"]{padding:0;border:none;width:32px;height:32px}
    button{cursor:pointer;background:#e2e8f0;transition:.15s}
    button:hover{background:#cbd5e1}
    button:active{background:#94a3b8;color:#fff}
    #edit{display:none;flex-direction:column;gap:.5rem;border:1px solid #e2e8f0;border-radius:.5rem;padding:.75rem}
    #spaceInfo{font-size:.85rem;color:#0f172a;border:1px solid #e2e8f0;border-radius:.5rem;padding:.5rem;background:#f1f5f9}
    /* layer‑order arrows */
    .arrow{margin-left:auto;padding:0 4px;font-size:.8rem;background:none;border:none;cursor:pointer;color:#475569}
    .arrow:hover{color:#1e293b}
    .arrow:disabled{opacity:.3;cursor:default}
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js">
document.getElementById("downloadInventory").addEventListener("click", () => {
  const w = window.open("", "_blank");
  const rows = items.map(it => {
    const colorCell = `<td><div style='background:${it.color};padding:4px;border-radius:3px;color:#0f172a;text-align:center;'>${it.color}</div></td>`;
    return `
      <tr>
        <td>${it.label || ""}</td>
        <td>${inch(it.w).toFixed(1)}</td>
        <td>${inch(it.h).toFixed(1)}</td>
        ${colorCell}
        <td>${it.note || ""}</td>
      </tr>
    `;
  }).join("");

  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Inventory Sheet</title>
      <style>
        body { font-family: sans-serif; padding: 2rem; }
        table { border-collapse: collapse; width: 100%; font-size: 12px; }
        th, td { border: 1px solid #ccc; padding: 4px; }
        th { background: #f1f5f9; }
        h2 { margin-bottom: 1rem; }
      </style>
    </head>
    <body>
      <h2>Inventory Sheet</h2>
      <table>
        <thead>
          <tr>
            <th>Label</th><th>Width (in)</th><th>Height (in)</th><th>Color</th><th>Notes</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </body>
    </html>
  `;

  w.document.write(html);
  w.document.close();
});
</script><style>
#printable-inventory {
  font-family: sans-serif;
}
#printable-inventory table {
  width: 100%;
  border-collapse: collapse;
}
#printable-inventory th, #printable-inventory td {
  border: 1px solid #ccc;
  padding: 4px;
  font-size: 12px;
}
#printable-inventory th {
  background: #f1f5f9;
}
</style></head>
<body>
<!-- ── Main column (canvas & global buttons) ── -->
<div style="display:flex;flex-direction:column;align-items:center;gap:.75rem">
<h1 style="font-size:1.25rem;margin:0;font-weight:600">Bedroom Layout Planner v12.2<br/>(12 × 10 ft room • 45 × 24 in closet)</h1>
<canvas height="720" id="stage" width="720"></canvas>
<div style="display:flex;gap:.75rem">
<button id="savePng">Save PNG</button>
<button id="saveLayout">Save Layout</button>
<button id="loadLayout">Load Layout</button>
<input accept="application/json" id="fileInput" style="display:none" type="file"/>
</div>
</div>
<!-- ── Side panel ── -->
<div style="display:flex; gap:1rem; align-items:flex-start"><div style="display:flex;gap:1.5rem;align-items:flex-start"><div id="panel">
<h2>Objects</h2>
<fieldset style="border:1px solid #cbd5e1; padding:.5rem; border-radius:.5rem; display:flex; flex-direction:column; gap:.35rem">
<legend style="font-size:.85rem; color:#0f172a; font-weight:600">Measurement Tools</legend>
<label style="display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:#0f172a">
<input id="measureToggle" type="checkbox"/> Use Measurement Tool
  </label>
<small style="margin-left:1.5rem; font-size:.75rem; color:#475569">
    Click two points to measure distance in inches &amp; feet.
  </small>
<label style="display:flex;align-items:center;gap:.5rem;font-size:.85rem;color:#0f172a">
<input id="walkwayToggle" type="checkbox"/> Enable Walkway Validator
  </label>
<label style="font-size:.8rem;color:#475569;display:flex;align-items:center;gap:.5rem">
    Min Walkway Width (in): <input id="walkwayMin" style="width:60px" type="number" value="24"/>
</label>
<label style="display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:#475569">
<input id="walkwayLiveToggle" type="checkbox"/> Show Walkway Issues While Dragging
  </label><small style="margin-left:1.5rem; font-size:.75rem; color:#64748b">Walkway Validator must be enabled</small>
</fieldset>
<ul id="objList"><li class=""><div class="row"><span class="swatch" style="background: rgb(176, 196, 222);"></span>Twin XL Bed<button class="arrow" disabled="">↑</button><button class="arrow">↓</button></div><span class="dim">82×40″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(222, 184, 135);"></span>Nightstand 1<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">16×22″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(255, 228, 181);"></span>Long Dresser<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">20×70″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(167, 243, 208);"></span>Computer Chair<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">27×27″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(119, 113, 95);"></span>Computer Desk<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">46×22″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(97, 187, 194);"></span>Stand Up Dresser<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">32.50×19.50″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(167, 243, 208);"></span>Bookshelf<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">11.50×30″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(167, 243, 208);"></span>Old Night<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">16×29″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(167, 243, 208);"></span>Black Cube<button class="arrow">↑</button><button class="arrow">↓</button></div><span class="dim">12×16″</span></li><li class=""><div class="row"><span class="swatch" style="background: rgb(222, 184, 135);"></span>Nightstand 2<button class="arrow">↑</button><button class="arrow" disabled="">↓</button></div><span class="dim">22×16″</span></li></ul>
<button id="addObj">➕ Add Object</button>
<fieldset style="border:1px solid #cbd5e1; padding:.5rem; border-radius:.5rem; display:flex; flex-direction:column; gap:.35rem">
<legend style="font-size:.85rem; color:#0f172a; font-weight:600">Object Tools</legend>
<label style="font-size:.85rem;color:#0f172a;display:flex;align-items:center;gap:.5rem">
<input checked="" id="gapToggle" type="checkbox"/> Show Gaps Between Objects
</label><label style="font-size:.85rem;color:#0f172a;display:flex;align-items:center;gap:.5rem">
<input checked="" id="noteToggle" type="checkbox"/> Show Object Notes
</label></fieldset>
<div id="spaceInfo">Free space: 59.8 ft²  (8604 in²)</div>
<button id="clearSavedLayout" style="margin-top:.5rem; padding:.5rem; background:#ef4444; color:white; border:none; border-radius:4px; font-size:.85rem; cursor:pointer">Clear Saved Layout</button><div style="margin-top:.75rem; display:flex; gap:.5rem; padding:.5rem; background:#f1f5f9; border:1px solid #cbd5e1; border-radius:.5rem;"><button id="exportInventory" style="margin-top:.75rem; padding:.5rem; background:#2563eb; color:white; border:none; border-radius:4px; font-size:.85rem; cursor:pointer">Generate Inventory Sheet</button><button disabled="true" id="downloadInventory" style="margin-left:.5rem; padding:.5rem; background:#0f766e; color:white; border:none; border-radius:4px; font-size:.85rem; cursor:pointer">Open Inventory in New Tab</button></div></div><div style="display:flex;flex-direction:column;gap:1rem;align-items:flex-start"><div id="edit" style="display:none; flex-direction:column; gap:.5rem; border:1px solid #e2e8f0; border-radius:.5rem; padding:.75rem; min-width:220px">
<h2 style="font-size:1rem">Edit Selected</h2>
<label>Name <input id="nameInp"/></label>
<label>Width (in) <input id="wInp" step="0.25" type="number"/></label>
<label>Height (in) <input id="hInp" step="0.25" type="number"/></label>
<label>Color <input id="colInp" type="color"/></label>
<label>Transparency (α) <input id="alphaInp" max="1" min="0" step="0.05" type="range"/></label>
<button id="delObj" style="background:#fecaca">🗑 Delete</button>
<label>Notes <input id="noteInp" type="text"/></label>
<div style="display:flex;flex-wrap:wrap;gap:4px"><span style="font-size:.8rem;color:#475569">Quick Colors:</span><button class="presetColor" data-color="#9ca3af" style="background:#9ca3af;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Metal/Neutral Gray" type="button"></button><button class="presetColor" data-color="#d97706" style="background:#d97706;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Wood" type="button"></button><button class="presetColor" data-color="#2563eb" style="background:#2563eb;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Plastic/Blue" type="button"></button><button class="presetColor" data-color="#16a34a" style="background:#16a34a;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Green/Fabric" type="button"></button><button class="presetColor" data-color="#dc2626" style="background:#dc2626;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Important/Alert" type="button"></button><button class="presetColor" data-color="#facc15" style="background:#facc15;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Caution/Label" type="button"></button><button class="presetColor" data-color="#9333ea" style="background:#9333ea;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Electronics" type="button"></button><button class="presetColor" data-color="#f59e0b" style="background:#f59e0b;width:20px;height:20px;border:1px solid #ccc;border-radius:4px" title="Cardboard/Boxes" type="button"></button></div>
<label style="font-size:.85rem;color:#0f172a;display:flex;align-items:center;gap:.5rem">
<input checked="" id="rulerToggle" type="checkbox"/> Show Ruler/Grid Labels
</label>
</div><div id="inventorySheet" style="margin-top:1rem; display:none; max-height:180px; overflow:auto; border:1px solid #e2e8f0; border-radius:4px; padding:.25rem;"></div></div></div></div>
<script>
/***** ── Constants & geometry ── *****/
const SCALE = 5;                     // 1 inch → 5 pixels
const ROOM_W_IN = 144, ROOM_H_IN = 120;
const CLOSET_W_IN = 45,  CLOSET_H_IN = 24;
const TOTAL_H_IN  = ROOM_H_IN + CLOSET_H_IN;
const UNIT_W = ROOM_W_IN * SCALE;
const UNIT_H = ROOM_H_IN * SCALE;
const CLOSET_W_PX = CLOSET_W_IN * SCALE;
const CLOSET_H_PX = CLOSET_H_IN * SCALE;
const CANVAS_H = TOTAL_H_IN * SCALE;
const PILLAR = 3 * SCALE;            // 3‑in pillars/trim
const LEFT_PILLAR_LEN = 50 * SCALE;  // left vertical pillar height
const MEAS_VERT_IN = 33, MEAS_HORZ_IN = 39.5;
const DOOR_W_IN = 30, DOOR_H_IN = 30;
const DOOR_W_PX = DOOR_W_IN * SCALE, DOOR_H_PX = DOOR_H_IN * SCALE;
const DOOR_X = 0, DOOR_Y = CLOSET_H_PX;

/***** ── Helper utilities ── *****/
const make = (label,w,h,x,y,color) => ({ note: '',
  id: crypto.randomUUID(),
  label,
  w: w * SCALE,
  h: h * SCALE,
  x,
  y,
  color,
  angle: 0,
  alpha: 1
});
const inch = px => px / SCALE;
const dimsTxt = it => `${inch(it.w).toFixed(2).replace(/\.00$/,'')}×${inch(it.h).toFixed(2).replace(/\.00$/,'')}″`;

/***** ── Initial sample items ── *****/
let items = (() => {
  const raw = [
    {label:'Twin XL Bed', width_in:82, height_in:40, x_in:58.4, y_in:100.4, color:'#b0c4de', angle:0, alpha:1},
    {label:'Nightstand',   width_in:20, height_in:20, x_in:120.2,y_in:79.6,  color:'#deb887', angle:0, alpha:1},
    {label:'Stand Up Dresser', width_in:20, height_in:42, x_in:3.6,  y_in:98.6, color:'#ffe4b5', angle:0, alpha:1},
    {label:'Computer Chair',   width_in:27, height_in:27, x_in:106.6,y_in:45.6, color:'#a7f3d0', angle:0, alpha:0.8},
    {label:'Computer Desk',    width_in:48, height_in:23.5,x_in:93.8, y_in:24.2, color:'#77715f', angle:0, alpha:0.95},
    {label:'Stand Up Dresser V2',width_in:42,height_in:20,x_in:40.6,y_in:24.4,color:'#ffe4b5', angle:0, alpha:0.8}
  ];
  return raw.map(o => {
    const it = make(o.label,o.width_in,o.height_in,o.x_in*SCALE,o.y_in*SCALE,o.color);
    it.angle = o.angle || 0;
    it.alpha = o.alpha ?? 1;
    return it;
  });
})();

/***** ── Canvas setup & shared state ── *****/
const canvas = document.getElementById('stage');
canvas.height = CANVAS_H;
const ctx = canvas.getContext('2d');
let selected = null;
let drag = false;
let offX = 0, offY = 0;
const dims = it => (it.angle % 180 === 0 ? {w:it.w,h:it.h} : {w:it.h,h:it.w});

/***** ── Drawing routine ── *****/
function draw(){
  ctx.clearRect(0,0,UNIT_W,CANVAS_H);
  ctx.fillStyle = '#ffffff';  // solid white BG (for PNG)
  ctx.fillRect(0,0,UNIT_W,CANVAS_H);

  // closet & unusable strip
  ctx.fillStyle = '#fff';         ctx.fillRect(0,0,CLOSET_W_PX,CLOSET_H_PX);
  ctx.fillStyle = '#111827';      ctx.fillRect(CLOSET_W_PX,0,UNIT_W-CLOSET_W_PX,CLOSET_H_PX);
  ctx.setLineDash([8,6]);
  ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2; ctx.strokeRect(0,0,CLOSET_W_PX,CLOSET_H_PX);
  ctx.setLineDash([]);

  // door footprint
  ctx.fillStyle='#f9fafb'; ctx.fillRect(DOOR_X,DOOR_Y,DOOR_W_PX,DOOR_H_PX);
  ctx.setLineDash([6,4]); ctx.strokeStyle='#d1d5db'; ctx.strokeRect(DOOR_X,DOOR_Y,DOOR_W_PX,DOOR_H_PX); ctx.setLineDash([]);
  ctx.fillStyle='#1e293b'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText('DOOR SPACE', DOOR_X+DOOR_W_PX/2, DOOR_Y+DOOR_H_PX/2);

  // gray pillar trims
  ctx.fillStyle='#e5e7eb';
  ctx.fillRect(0,CANVAS_H-LEFT_PILLAR_LEN,PILLAR,LEFT_PILLAR_LEN);
  ctx.fillRect(UNIT_W-PILLAR,0,PILLAR,CANVAS_H);
  ctx.fillRect(0,CANVAS_H-PILLAR,UNIT_W,PILLAR);

  // grid lines
  ctx.strokeStyle='#f3f4f6'; ctx.lineWidth=1;
  for(let x=PILLAR;x<=UNIT_W-PILLAR;x+=60){ctx.beginPath(); ctx.moveTo(x,CLOSET_H_PX); ctx.lineTo(x,CANVAS_H); ctx.stroke();}
  for(let y=CLOSET_H_PX;y<=CANVAS_H;y+=60){ctx.beginPath(); ctx.moveTo(PILLAR,y); ctx.lineTo(UNIT_W-PILLAR,y); ctx.stroke();}
  for(let x=0;x<=CLOSET_W_PX;x+=60){ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,CLOSET_H_PX); ctx.stroke();}
  for(let y=0;y<=CLOSET_H_PX;y+=60){ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(CLOSET_W_PX,y); ctx.stroke();}

  
  if (document.getElementById('rulerToggle').checked) {
    ctx.fillStyle = '#1e293b';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let x = PILLAR; x <= UNIT_W - PILLAR; x += 60) {
      ctx.fillText(`${inch(x).toFixed(0)}″`, x, CLOSET_H_PX + 2);
    }
    ctx.textAlign = 'right';
    for (let y = CLOSET_H_PX; y <= CANVAS_H; y += 60) {
      ctx.fillText(`${inch(y - CLOSET_H_PX).toFixed(0)}″`, UNIT_W - 4, y + 2);

  

    }

  

  }


// zone labels & measurement reference
  ctx.fillStyle='#1e293b'; ctx.font='bold 16px sans-serif';
  ctx.fillText('CLOSET', CLOSET_W_PX/2, CLOSET_H_PX/2);
  ctx.fillText('BEDROOM', UNIT_W/2, CLOSET_H_PX + UNIT_H/2);
  
  ctx.beginPath(); ctx.moveTo(0,CLOSET_H_PX); ctx.lineTo(0, CLOSET_H_PX + MEAS_VERT_IN*SCALE); ctx.stroke();

  // reference red bars (requested markers)
  ctx.fillStyle='#dc2626';
  ctx.fillRect(UNIT_W - PILLAR - 63, CLOSET_H_PX + 5, 60, 4);                         // top‑right bar
  ctx.fillRect(PILLAR - 2, CLOSET_H_PX + UNIT_H/2 - 30, 4, 60);                       // left‑mid bar
  ctx.fillRect(UNIT_W/2 - 30, CANVAS_H - PILLAR - 9, 60, 4);                          // bottom‑mid bar

  // draw all items (in current z‑order)
  for(const it of items){
    ctx.save();
    ctx.translate(it.x + it.w/2, it.y + it.h/2);
    ctx.rotate(it.angle * Math.PI / 180);
    ctx.globalAlpha = it.alpha;

    ctx.fillStyle = it.color;
    ctx.fillRect(-it.w/2, -it.h/2, it.w, it.h);
    ctx.strokeStyle='#475569'; ctx.lineWidth=2;
    ctx.strokeRect(-it.w/2, -it.h/2, it.w, it.h);

    ctx.fillStyle='#000'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
    const lines = [it.label, dimsTxt(it)];
    
lines.forEach((ln,i)=> ctx.fillText(ln, 0, (i-(lines.length-1)/2)*14));
if (document.getElementById("noteToggle").checked && it.note) {
  ctx.fillText(it.note, 0, ((lines.length + 1) * 14));
}

    if (document.getElementById("noteToggle").checked && it.note) {
  
}

    if (it.note) {
      
    }

    if (it.note) {
      
    }


    ctx.restore();
  }

  // Closet measurement reference lines (overlaid and clearly visible)
  if (document.getElementById('rulerToggle').checked) {
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;

    // Horizontal measurement line at top of closet
    ctx.beginPath();
    ctx.moveTo(PILLAR, CLOSET_H_PX - 8);
    ctx.lineTo(PILLAR + MEAS_HORZ_IN * SCALE, CLOSET_H_PX - 8);
    ctx.stroke();

    // Vertical measurement line at left of closet
    ctx.beginPath();
    ctx.moveTo(PILLAR - 8, CLOSET_H_PX);
    ctx.lineTo(PILLAR - 8, CLOSET_H_PX + MEAS_VERT_IN * SCALE);
    ctx.stroke();
  }


  // Feet axis labels for left (Y) and bottom (X)
  if (document.getElementById('rulerToggle').checked) {
    ctx.fillStyle = '#1e293b';
    ctx.font = '10px sans-serif';

    // Left (feet)
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (let y = CLOSET_H_PX; y <= CANVAS_H; y += SCALE * 12) {
      ctx.fillText(`${((y - CLOSET_H_PX)/SCALE/12).toFixed(0)}′`, PILLAR - 4, y);
    }

    // Bottom (feet)
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let x = PILLAR; x <= UNIT_W - PILLAR; x += SCALE * 12) {
      ctx.fillText(`${(x/SCALE/12).toFixed(0)}′`, x, CANVAS_H - PILLAR + 4);
    }

    // Unit Labels
    ctx.font = 'bold 11px sans-serif';
    ctx.fillText('inches →', UNIT_W / 2, CLOSET_H_PX + 10);
    ctx.save();
    ctx.translate(PILLAR - 20, CLOSET_H_PX + UNIT_H / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('inches →', 0, 0);
    ctx.restore();

    ctx.fillText('feet ↓', UNIT_W / 2, CANVAS_H - PILLAR + 16);
    ctx.save();
    ctx.translate(PILLAR - 28, CLOSET_H_PX + UNIT_H / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('feet ↓', 0, 0);
    ctx.restore();
  }


  


  // Feet axis labels for left (Y) and bottom (X)
  if (document.getElementById('rulerToggle').checked) {
    ctx.fillStyle = '#1e293b';
    ctx.font = '10px sans-serif';

    // Left (feet)
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for (let y = CLOSET_H_PX; y <= CANVAS_H; y += SCALE * 12) {
      ctx.fillText(`${((y - CLOSET_H_PX)/SCALE/12).toFixed(0)}′`, PILLAR - 4, y);
    }

    // Bottom (feet)
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    for (let x = PILLAR; x <= UNIT_W - PILLAR; x += SCALE * 12) {
      ctx.fillText(`${(x/SCALE/12).toFixed(0)}′`, x, CANVAS_H - PILLAR + 4);
    }

    // Unit Labels
    ctx.font = 'bold 11px sans-serif';
    ctx.fillText('inches →', UNIT_W / 2, CLOSET_H_PX + 10);
    ctx.save();
    ctx.translate(PILLAR - 20, CLOSET_H_PX + UNIT_H / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('inches →', 0, 0);
    ctx.restore();

    ctx.fillText('feet ↓', UNIT_W / 2, CANVAS_H - PILLAR + 16);
    ctx.save();
    ctx.translate(PILLAR - 28, CLOSET_H_PX + UNIT_H / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('feet ↓', 0, 0);
    ctx.restore();
  }


  
  // --- Optional: Show distances from selected object to others ---
  if (selected && document.getElementById('gapToggle').checked) {
    ctx.strokeStyle = '#10b981'; // green
    ctx.fillStyle = '#064e3b';
    ctx.font = '12px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';

    const selDims = dims(selected);
    const selRight = selected.x + selDims.w;
    const selBottom = selected.y + selDims.h;

    for (const it of items) {
      if (it === selected) continue;
      const itDims = dims(it);
      const itRight = it.x + itDims.w;
      const itBottom = it.y + itDims.h;

      // Horizontal spacing (if vertically aligned)
      const vertOverlap = Math.max(0, Math.min(selected.y + selDims.h, it.y + itDims.h) - Math.max(selected.y, it.y));
      if (vertOverlap > 10) {
        if (it.x >= selRight) {
          const gap = it.x - selRight;
          ctx.beginPath();
          ctx.moveTo(selRight, selected.y + selDims.h / 2);
          ctx.lineTo(it.x, it.y + itDims.h / 2);
          ctx.stroke();
          ctx.fillText(`${inch(gap).toFixed(1)}″`, (selRight + it.x) / 2, selected.y + selDims.h / 2 - 4);
        } else if (selected.x >= itRight) {
          const gap = selected.x - itRight;
          ctx.beginPath();
          ctx.moveTo(itRight, it.y + itDims.h / 2);
          ctx.lineTo(selected.x, selected.y + selDims.h / 2);
          ctx.stroke();
          ctx.fillText(`${inch(gap).toFixed(1)}″`, (itRight + selected.x) / 2, selected.y + selDims.h / 2 - 4);
        }
      }

      // Vertical spacing (if horizontally aligned)
      const horizOverlap = Math.max(0, Math.min(selRight, itRight) - Math.max(selected.x, it.x));
      if (horizOverlap > 10) {
        if (it.y >= selBottom) {
          const gap = it.y - selBottom;
          ctx.beginPath();
          ctx.moveTo(selected.x + selDims.w / 2, selBottom);
          ctx.lineTo(it.x + itDims.w / 2, it.y);
          ctx.stroke();
          ctx.fillText(`${inch(gap).toFixed(1)}″`, selected.x + selDims.w / 2, (selBottom + it.y) / 2 - 4);
        } else if (selected.y >= itBottom) {
          const gap = selected.y - itBottom;
          ctx.beginPath();
          ctx.moveTo(it.x + itDims.w / 2, itBottom);
          ctx.lineTo(selected.x + selDims.w / 2, selected.y);
          ctx.stroke();
          ctx.fillText(`${inch(gap).toFixed(1)}″`, selected.x + selDims.w / 2, (itBottom + selected.y) / 2 - 4);
        }
      }
    }
  }
updateSpace();
drawMeasurement();
drawWalkwayViolations();
}

/***** ── Space calculation ── *****/
const spaceInfo = document.getElementById('spaceInfo');
function updateSpace(){
  const totalArea  = ROOM_W_IN*ROOM_H_IN + CLOSET_W_IN*CLOSET_H_IN;
  const grayArea   = (3*TOTAL_H_IN) + (3*50) + (3*ROOM_W_IN) - 18; // rough pillar/trim
  const furniture  = items.reduce((sum,it)=> sum + inch(it.w)*inch(it.h), 0);
  const free       = Math.max(0, totalArea - grayArea - furniture);
  spaceInfo.textContent = `Free space: ${(free/144).toFixed(1)} ft²  (${free.toFixed(0)} in²)`;
}

/***** ── Object list + editor ── *****/
const listEl     = document.getElementById('objList');
const editBox    = document.getElementById('edit');
const nameInp    = document.getElementById('nameInp');
const wInp       = document.getElementById('wInp');
const hInp       = document.getElementById('hInp');
const colInp     = document.getElementById('colInp');

function moveItem(idx,dir){
  const newIdx = idx + dir;
  if(newIdx < 0 || newIdx >= items.length) return;
  const [it] = items.splice(idx,1);
  items.splice(newIdx,0,it);
  refreshList(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
}

function refreshList(){
  listEl.innerHTML='';
  items.forEach((it,idx)=>{
    const li = document.createElement('li');
    li.className = it === selected ? 'active' : '';

    const row = document.createElement('div'); row.className='row';
    const sw  = document.createElement('span'); sw.className='swatch'; sw.style.background = it.color; row.appendChild(sw);
    row.appendChild(document.createTextNode(it.label));

    const up = document.createElement('button');  up.textContent='↑'; up.className='arrow'; up.disabled = idx===0; up.onclick = e=>{e.stopPropagation(); moveItem(idx,-1);};
    const dn = document.createElement('button');  dn.textContent='↓'; dn.className='arrow'; dn.disabled = idx===items.length-1; dn.onclick = e=>{e.stopPropagation(); moveItem(idx,1);};
    row.appendChild(up); row.appendChild(dn);

    li.appendChild(row);
    const dim = document.createElement('span'); dim.className='dim'; dim.textContent = dimsTxt(it); li.appendChild(dim);

    li.onclick = ()=>{ selected = it; refreshList(); updateEditor(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw(); };
    listEl.appendChild(li);
  });
}

function updateEditor(){
  if(!selected){ editBox.style.display='none'; return; }
  editBox.style.display='flex';
  nameInp.value  = selected.label;
  wInp.value     = inch(selected.w).toFixed(2);
  hInp.value     = inch(selected.h).toFixed(2);
  colInp.value   = selected.color;
  alphaInp.value = selected.alpha;
}

function applyChanges(){
  if(!selected) return;
  selected.label = nameInp.value.trim() || 'Unnamed';
  selected.w     = parseFloat(wInp.value||0) * SCALE;
  selected.h     = parseFloat(hInp.value||0) * SCALE;
  selected.color = colInp.value;
  selected.alpha = parseFloat(alphaInp.value);
  if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw(); refreshList();
}
[nameInp,wInp,hInp,colInp,alphaInp].forEach(inp=> inp.oninput = applyChanges);

document.getElementById('delObj').onclick = () => {
  if(!selected) return;
  items = items.filter(it=> it!==selected);
  selected = null;
  refreshList(); updateEditor(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
};

document.getElementById('addObj').onclick = () => {
  const base = make('New',12,12,UNIT_W/2,CLOSET_H_PX + UNIT_H/2,'#a7f3d0');
  base.alpha = 0.8;
  items.push(base);
  selected = base;
  refreshList(); updateEditor(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
};

/***** ── Drag & hit‑testing ── *****/
function hit(it,px,py){
  const cx = it.x + it.w/2, cy = it.y + it.h/2;
  const dx = px - cx, dy = py - cy;
  const rad = -it.angle * Math.PI / 180;
  const rx = dx*Math.cos(rad) - dy*Math.sin(rad);
  const ry = dx*Math.sin(rad) + dy*Math.cos(rad);
  return rx > -it.w/2 && rx < it.w/2 && ry > -it.h/2 && ry < it.h/2;
}

canvas.addEventListener('pointerdown',e=>{
  const rect = canvas.getBoundingClientRect();
  const px = e.clientX - rect.left;
  const py = e.clientY - rect.top;
  selected = null;
  for(let i=items.length-1;i>=0;i--){
    if(hit(items[i],px,py)){
      selected = items[i];
      offX = px - (selected.x + selected.w/2);
      offY = py - (selected.y + selected.h/2);
      drag = true;
      break;
    }
  }
  refreshList(); updateEditor(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
});

canvas.addEventListener('pointermove',e=>{
  if(!drag || !selected) return;
  const rect = canvas.getBoundingClientRect();
  let nx = e.clientX - rect.left - selected.w/2 - offX;
  let ny = e.clientY - rect.top  - selected.h/2 - offY;

  const {w:horiz, h:vert} = dims(selected);
  const minY = 0, maxY = CANVAS_H - vert;
  let   minX = 0, maxX = UNIT_W - horiz;
  if(ny < CLOSET_H_PX){ maxX = CLOSET_W_PX - horiz; }

  selected.x = Math.min(Math.max(nx, minX), maxX);
  selected.y = Math.min(Math.max(ny, minY), maxY);
  if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
});
window.addEventListener('pointerup',()=> drag = false);

/***** ── Save / Load ── *****/
const savePng     = document.getElementById('savePng');
const saveLayout  = document.getElementById('saveLayout');
const loadLayout  = document.getElementById('loadLayout');
const fileInput   = document.getElementById('fileInput');

savePng.onclick = ()=>{
  const a = document.createElement('a');
  a.download = 'bedroom-layout.png';
  a.href = canvas.toDataURL('image/png');
  a.click();
};

saveLayout.onclick = ()=>{
  const json = JSON.stringify(items.map(it=>({
    label:it.label,
    width_in:inch(it.w),
    height_in:inch(it.h),
    x_in:inch(it.x),
    y_in:inch(it.y),
    color:it.color,
    angle:it.angle,
    alpha:it.alpha, note:it.note || ""
  })),null,2);
  const blob = new Blob([json],{type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'bedroom-layout.json'; a.click();
  URL.revokeObjectURL(url);
};

loadLayout.onclick = ()=> fileInput.click();
fileInput.onchange = e =>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    let arr;
    try {
      arr = JSON.parse(evt.target.result);
      if(!Array.isArray(arr)) throw new Error('Root is not array');
    } catch(err){
      alert('Invalid layout file – please choose a JSON created via “Save Layout”.');
      return;
    }

    items = arr.map(o=> make(
      o.label || 'Item',
      +o.width_in   || 12,
      +o.height_in  || 12,
      (+o.x_in || 0)*SCALE,
      (+o.y_in || 0)*SCALE,
      o.color || '#ddd'
    ));
    items.forEach((it,i)=>{ it.note = arr[i].note || "";
      it.angle = +arr[i].angle || 0;
      it.alpha = arr[i].alpha ?? 1;
    });

    selected = null;
    refreshList(); updateEditor(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
  };
  reader.readAsText(file);
  fileInput.value = '';
};

/***** ── Kick everything off ── *****/
refreshList(); if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();

// --- Preset color buttons ---
document.querySelectorAll(".presetColor").forEach(btn => {
  btn.addEventListener("click", () => {
    if (selected) {
      selected.color = btn.dataset.color;
      colInp.value = btn.dataset.color;
      if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
      refreshList();
    }
  });
});

// Add note field to object model and editor
const noteInp = document.getElementById('noteInp');
noteInp.oninput = () => {
  if (selected) {
    selected.note = noteInp.value.trim();
    if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
  }
};

function updateEditor(){
  if(!selected){ editBox.style.display='none'; return; }
  editBox.style.display='flex';
  nameInp.value  = selected.label;
  wInp.value     = inch(selected.w).toFixed(2);
  hInp.value     = inch(selected.h).toFixed(2);
  colInp.value   = selected.color;
  alphaInp.value = selected.alpha;
  noteInp.value  = selected.note || '';
}

// --- Redraw on note toggle ---
document.getElementById("noteToggle").addEventListener("change", draw);


let measureStart = null;
let measureEnd = null;
let measuring = false;

canvas.addEventListener("pointerdown", e => {
  if (!document.getElementById("measureToggle").checked) return;
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if (!measuring) {
    measureStart = {x, y};
    measureEnd = null;
    measuring = true;
  } else {
    measureEnd = {x, y};
    measuring = false;
    if (document.getElementById("walkwayLiveToggle").checked) drawWalkwayViolations(true);
draw();
  }
});

function drawMeasurement() {
  if (!document.getElementById("measureToggle").checked) return;
  if (!measureStart || !measureEnd) return;

  const dx = measureEnd.x - measureStart.x;
  const dy = measureEnd.y - measureStart.y;
  const distPx = Math.sqrt(dx*dx + dy*dy);
  const distIn = inch(distPx);
  const distFt = distIn / 12;

  ctx.strokeStyle = "#dc2626";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(measureStart.x, measureStart.y);
  ctx.lineTo(measureEnd.x, measureEnd.y);
  ctx.stroke();

  ctx.fillStyle = "#000";
  ctx.font = "12px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillText(`${distIn.toFixed(1)}″ (${distFt.toFixed(2)}′)`,
               (measureStart.x + measureEnd.x) / 2,
               (measureStart.y + measureEnd.y) / 2 - 6);
}


function drawWalkwayViolations(live = false) {
  if (!document.getElementById("walkwayToggle").checked && !live) return;
  const minGapIn = parseFloat(document.getElementById("walkwayMin").value || "0");
  const minGapPx = minGapIn * SCALE;

  ctx.strokeStyle = "#f97316";
  ctx.lineWidth = 2;
  ctx.setLineDash([5, 3]);

  for (let i = 0; i < items.length; i++) {
    const a = items[i];
    const ad = dims(a);
    const ax1 = a.x, ax2 = a.x + ad.w, ay1 = a.y, ay2 = a.y + ad.h;

    for (let j = i + 1; j < items.length; j++) {
      const b = items[j];
      const bd = dims(b);
      const bx1 = b.x, bx2 = b.x + bd.w, by1 = b.y, by2 = b.y + bd.h;

      const overlapX = Math.max(0, Math.min(ax2, bx2) - Math.max(ax1, bx1));
      const overlapY = Math.max(0, Math.min(ay2, by2) - Math.max(ay1, by1));

      if (overlapY > 0) {
        if (ax2 < bx1 && (bx1 - ax2) < minGapPx) {
          const y = (Math.max(ay1, by1) + Math.min(ay2, by2)) / 2;
          ctx.beginPath(); ctx.moveTo(ax2, y); ctx.lineTo(bx1, y); ctx.stroke();
        }
        if (bx2 < ax1 && (ax1 - bx2) < minGapPx) {
          const y = (Math.max(ay1, by1) + Math.min(ay2, by2)) / 2;
          ctx.beginPath(); ctx.moveTo(bx2, y); ctx.lineTo(ax1, y); ctx.stroke();
        }
      }

      if (overlapX > 0) {
        if (ay2 < by1 && (by1 - ay2) < minGapPx) {
          const x = (Math.max(ax1, bx1) + Math.min(ax2, bx2)) / 2;
          ctx.beginPath(); ctx.moveTo(x, ay2); ctx.lineTo(x, by1); ctx.stroke();
        }
        if (by2 < ay1 && (ay1 - by2) < minGapPx) {
          const x = (Math.max(ax1, bx1) + Math.min(ax2, bx2)) / 2;
          ctx.beginPath(); ctx.moveTo(x, by2); ctx.lineTo(x, ay1); ctx.stroke();
        }
      }
    }
  }

  ctx.setLineDash([]);
}


document.getElementById("exportInventory").addEventListener("click", () => {
  const container = document.getElementById("inventorySheet");
  container.innerHTML = "";

  const table = document.createElement("table");
  table.style.borderCollapse = "collapse";
  table.style.width = "100%";
  table.style.marginTop = "0.5rem";

  const headers = ["Label", "Width (in)", "Height (in)", "Color", "Notes"];
  const thead = document.createElement("thead");
  const headRow = document.createElement("tr");
  headers.forEach(h => {
    const th = document.createElement("th");
    th.textContent = h;
    th.style.border = "1px solid #ccc";
    th.style.padding = "4px";
    th.style.background = "#f1f5f9";
    headRow.appendChild(th);
  });
  thead.appendChild(headRow);
  table.appendChild(thead);

  const tbody = document.createElement("tbody");
  items.forEach(it => {
    const row = document.createElement("tr");
    const dims = it => {
      const scale = 1 / SCALE;
      return {
        w: it.w * scale,
        h: it.h * scale
      };
    };
    const d = dims(it);
    const cells = [
      it.label || "",
      inch(it.w).toFixed(1),
      inch(it.h).toFixed(1),
      it.color || "",
      it.note || ""
    ];
    
    cells.forEach((text, idx) => {
      const td = document.createElement("td");
      if (idx === 3) {
        td.innerHTML = `<span style='display:inline-block;width:100%;background:${text};padding:2px;border-radius:2px;color:#0f172a;text-align:center;font-size:.75rem'>${text}</span>`;
      } else {
        td.textContent = text;
      }
      td.style.border = "1px solid #ccc";
      td.style.padding = "4px";
      row.appendChild(td);
    });

    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  container.appendChild(table);
  container.style.display = "block";
});


document.getElementById("rulerToggle").addEventListener("change", () => {
  draw();
});


// Auto-save layout to localStorage
function saveToLocal() {
  const saveData = JSON.stringify(items.map(it => ({
    label: it.label,
    w: it.w,
    h: it.h,
    x: it.x,
    y: it.y,
    color: it.color,
    alpha: it.alpha,
    angle: it.angle,
    note: it.note
  })));
  localStorage.setItem("layoutAutosave", saveData);
}

// Auto-load layout from localStorage
function loadFromLocal() {
  const saved = localStorage.getItem("layoutAutosave");
  if (!saved) return;
  try {
    const arr = JSON.parse(saved);
    items = arr.map(it => ({
      ...it,
      id: crypto.randomUUID()
    }));
    refreshList();
    draw();
  } catch (e) {
    console.warn("Failed to load layout from localStorage", e);
  }
}

// Save on changes
setInterval(saveToLocal, 3000); // every 3 seconds
window.addEventListener("beforeunload", saveToLocal);

// Load once on startup
loadFromLocal();


document.getElementById("clearSavedLayout").addEventListener("click", () => {
  localStorage.removeItem("layoutAutosave");
  alert("Saved layout cleared from browser storage.");
});




// Enable the download button after generating the inventory
document.getElementById("exportInventory").addEventListener("click", () => {
  document.getElementById("downloadInventory").disabled = false;
});


document.getElementById("downloadInventory").addEventListener("click", () => {
  const content = document.getElementById("inventorySheet");
  const opt = {
    margin:       0.5,
    filename:     'InventorySheet.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2 },
    jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(content).save();
});
</script>
<div id="printable-inventory" style="display:none; padding:1rem;"></div></body></html>